<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Activity Logs - Atlas Security</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root { --bg-dark: #080810; --bg-card: #0d0d18; --border: #1a1a2e; --accent: #22c55e; --text: #e0e0e0; --text-dim: #888; }
        body { font-family: 'Inter', sans-serif; background: var(--bg-dark); color: var(--text); min-height: 100vh; }
        .header { background: var(--bg-card); border-bottom: 1px solid var(--border); padding: 16px 32px; display: flex; justify-content: space-between; align-items: center; }
        .header .nav { display: flex; align-items: center; gap: 24px; }
        .header .back { color: var(--text-dim); text-decoration: none; }
        .header h1 { font-size: 18px; color: #fff; }
        .container { max-width: 1200px; margin: 0 auto; padding: 32px; }
        .log-container { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; }
        .log-header { padding: 16px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; }
        .log-body { max-height: 70vh; overflow-y: auto; }
        .log-entry { padding: 12px 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 16px; }
        .log-entry:hover { background: rgba(34, 197, 94, 0.05); }
        .log-time { font-family: 'JetBrains Mono', monospace; font-size: 12px; color: var(--text-dim); min-width: 150px; }
        .log-admin { font-weight: 600; min-width: 100px; color: #8b5cf6; }
        .log-action { flex: 1; }
        .log-action .action-type { font-weight: 600; color: #fff; }
        .log-action .action-target { color: var(--text-dim); font-size: 13px; }
        .badge { display: inline-block; padding: 3px 8px; border-radius: 10px; font-size: 10px; font-weight: 600; margin-left: 8px; }
        .badge.login { background: rgba(59, 130, 246, 0.2); color: #3b82f6; }
        .badge.update { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
        .badge.ban { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        .badge.create { background: rgba(139, 92, 246, 0.2); color: #8b5cf6; }
        .empty { text-align: center; padding: 60px; color: var(--text-dim); }
        .refresh-btn { padding: 8px 16px; background: var(--accent); border: none; border-radius: 6px; color: #fff; font-size: 13px; cursor: pointer; }
    </style>
</head>
<body>
    <header class="header">
        <div class="nav">
            <a href="index.html" class="back">‚Üê Back</a>
            <h1>üìú Activity Logs</h1>
        </div>
        <button class="refresh-btn" onclick="fetchLogs()">Refresh</button>
    </header>

    <div class="container">
        <div class="log-container">
            <div class="log-header">
                <span>Admin Activity Log</span>
                <span id="logCount">-</span>
            </div>
            <div class="log-body" id="logBody">
                <div class="empty">Loading logs...</div>
            </div>
        </div>
    </div>

    <script>
        const API = location.hostname === 'localhost' ? 'http://localhost:3001' : 'https://api.klyra.lol';
        const token = localStorage.getItem('atlasToken');
        if (!token) location.href = 'index.html';

        const ACTION_BADGES = {
            'LOGIN': 'login', 'CREATE_ADMIN': 'create', 'UPDATE_SOULS': 'update',
            'UNLOCK_CHARACTERS': 'update', 'BAN_USER': 'ban', 'UNBAN_USER': 'update',
            'RESET_PASSWORD': 'update', 'VIEW_USERS': 'login', 'CHANGE_PASSWORD': 'update'
        };

        async function fetchLogs() {
            try {
                const res = await fetch(`${API}/atlas/activity?limit=200`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.status === 401) { location.href = 'index.html'; return; }
                const data = await res.json();
                const logs = data.logs || [];
                document.getElementById('logCount').textContent = `${logs.length} entries`;
                renderLogs(logs);
            } catch (e) {
                console.error(e);
                document.getElementById('logBody').innerHTML = '<div class="empty">Failed to load logs</div>';
            }
        }

        function renderLogs(logs) {
            const body = document.getElementById('logBody');
            if (logs.length === 0) {
                body.innerHTML = '<div class="empty">No activity logs yet</div>';
                return;
            }
            body.innerHTML = logs.map(l => {
                const badge = ACTION_BADGES[l.action] || 'update';
                const time = new Date(l.created_at).toLocaleString();
                const details = l.details ? JSON.parse(l.details) : null;
                let targetStr = '';
                if (l.target_type === 'user') targetStr = `User #${l.target_id}`;
                if (l.target_type === 'admin') targetStr = `Admin #${l.target_id}`;
                if (details?.username) targetStr = details.username;
                if (details?.souls !== undefined) targetStr += ` ‚Üí ${details.souls} souls`;
                if (details?.characters) targetStr += ` ‚Üí ${details.characters.join(', ')}`;

                return `
                    <div class="log-entry">
                        <div class="log-time">${time}</div>
                        <div class="log-admin">${l.admin_display_name || l.admin_username || '-'}</div>
                        <div class="log-action">
                            <span class="action-type">${l.action.replace(/_/g, ' ')}</span>
                            <span class="badge ${badge}">${badge}</span>
                            ${targetStr ? `<div class="action-target">${targetStr}</div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        fetchLogs();
        setInterval(fetchLogs, 30000);
    </script>
</body>
</html>
